<html>
<head>

</head>
<body>
<div id="roomNumber" hidden></div>
<div id="roomJoinCreate">
    <form action="/room/create" method="POST">
        <input type="password" name="pass" id="passCreate" placeholder="password"><br>
        <input type="submit" value="Create Room">
        <!--<button id="create">create room</button><br><br>-->
    </form>
    <input type="text" id="room" placeholder="room no.">
    <input type="text" id="passJoin" placeholder="password"><br>
    <button id="join">join room</button>
</div>
<br><br>
<video id="local_video" autoplay></video>
<video id="remote_video" autoplay></video>
</body>
<script>

    // document.getElementById('create').onclick = event => {
    //     ws.send('create ' + document.getElementById('passCreate').value);
    //     document.getElementById('roomJoinCreate').hidden = true;
    // };

    // document.getElementById('join').onclick = event => {
    //     ws.send('join ' + document.getElementById('room').value + ' ' + document.getElementById('passJoin').value);
    //     document.getElementById('roomJoinCreate').hidden = true;
    // };

    /*let elemVidLocal = document.getElementById('local_video');
    let elemVidRemote = document.getElementById('remote_video');

    let localStream = undefined;
    let localHasAudio = false;
    let localHasVideo = false;

    let host = window.location.hostname;
    let port = 9004;
    let ws = new WebSocket('wss://' + host + ':' + port);
    window.ws = ws;

    let startIce = false;
    let continueIce = false;
    let pc = new RTCPeerConnection({
        iceServers: [
            {url: 'stun:stun.1.google.com:19302'}
        ]
    });

    document.getElementById('create').onclick = event => {
        ws.send('create ' + document.getElementById('passCreate').value);
        document.getElementById('roomJoinCreate').hidden = true;
    };

    document.getElementById('join').onclick = event => {
        ws.send('join ' + document.getElementById('room').value + ' ' + document.getElementById('passJoin').value);
        document.getElementById('roomJoinCreate').hidden = true;
    };

    ws.onmessage = event => {
        let message = event.data;
        if (message === 'fail') {
            document.getElementById('passCreate').value = '';
            document.getElementById('room').value = '';
            document.getElementById('passJoin').value = '';
            document.getElementById('roomJoinCreate').hidden = false;
        }
        else if (message.startsWith('join ')) {
            let roomNumber = parseInt(message.substr(5));
            document.getElementById('roomNumber').innerHTML = 'Room Number: ' + roomNumber;
            document.getElementById('roomNumber').hidden = false;
            requestLocalStream();
        }
        else if (message === 'init') {
            if (localStream === undefined) {
                startIce = true;
            }
            else {
                startIceProcedure();
            }
        }
        else if (message.startsWith('s ')) {
            if (message.startsWith('s offer\n')) {
                let sdp = JSON.parse(message.substr(8));
                pc.setRemoteDescription(sdp);
                pc.onicecandidate = event => {
                    if (event.candidate) {
                        ws.send('s ice\n' + JSON.stringify(event.candidate));
                    }
                };
                pc.onaddstream = event => {
                    elemVidRemote.src = window.URL.createObjectURL(event.stream);
                };
                if (localStream === undefined) {
                    continueIce = true;
                }
                else {
                    continueIceProcedure();
                }
            }
            else if (message.startsWith('s answer\n')) {
                let sdp = JSON.parse(message.substr(9));
                pc.setRemoteDescription(sdp);
            }
            else if (message.startsWith('s ice\n')) {
                let ice = JSON.parse(message.substr(6));
                pc.addIceCandidate(ice).catch(event => {
                    console.log(event);
                });
            }
        }
    };

    function requestLocalStream() {
        navigator.getUserMedia({audio: true, video: true}, s => {
            localStream = s;
            localHasAudio = true;
            localHasVideo = true;
            onLocalStream();
        }, event => {
            console.log('Could not retrieve video input device');
            navigator.getUserMedia({audio: true}, s => {
                localStream = s;
                localHasAudio = true;
                localHasVideo = false;
                onLocalStream();
            }, event => {
                console.log('Could not retrieve audio input device');
                onLocalStream();
            });
        });

        function onLocalStream() {
            if (localStream === undefined || (!localHasAudio && !localHasVideo)) return undefined;
            if (localHasVideo) {
                elemVidLocal.src = window.URL.createObjectURL(localStream);
            }
            if (startIce === true) {
                startIce = false;
                startIceProcedure();
            }
            else if (continueIce === true) {
                continueIce = false;
                continueIceProcedure();
            }
        }
    }

    function startIceProcedure() {
        console.log('starting ICE procedure');
        pc.addStream(localStream);
        pc.createOffer().then(offer => {
            pc.setLocalDescription(offer);
            ws.send('s offer\n' + JSON.stringify(offer));
        });
        pc.onicecandidate = event => {
            if (event.candidate) {
                ws.send('s ice\n' + JSON.stringify(event.candidate));
            }
        };
        pc.onaddstream = event => {
            elemVidRemote.src = window.URL.createObjectURL(event.stream);
        }
    }
    function continueIceProcedure() {
        pc.addStream(localStream);
        pc.createAnswer().then(answer => {
            pc.setLocalDescription(answer);
            ws.send('s answer\n' + JSON.stringify(answer));
        });
    }*/

</script>
</html>
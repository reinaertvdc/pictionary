<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pictionary Game</title>
</head>
<body>
    <a href="/">HOME</a>
<script>

    let room = -1;
    let pass = '';

    let ws = undefined;

    let streamLocal = undefined;
    let streamLocalReady = false;

    if (typeof roomdetails !== 'undefined' && roomdetails !== undefined) {
        if (roomdetails.room !== undefined && typeof roomdetails.room === 'number') room = roomdetails.room;
        if (roomdetails.pass !== undefined && typeof roomdetails.pass === 'string') pass = roomdetails.pass;
    }
    else {
        room = parseInt(window.location.pathname.split('/',3)[2]);
    }
    if (room !== undefined && !isNaN(room)) {
        document.title = 'Pictionary Game (room ' + room + ')';
        createWebSocket().then(sock => {
            ws = sock;
            joinRoom(room, pass);
        }).catch(() => {
            alert('Could not create WebSocket connection to server');
        });
    }

    function createWebSocket() {
        return new Promise((resolve, reject) => {
            let host = window.location.hostname;
            let port = 9004;
            let ws = new WebSocket('wss://' + host + ':' + port);
            ws.onopen = event => {
                resolve(ws);
            };
            ws.onerror = event => {
                ws = undefined;
                reject();
            };
            ws.onmessage = event => {
                onWebSocketMessage(event.data);
            }
        });
    }

    function onWebSocketMessage(m) {
        if (typeof m === 'string') {
            try {
                m = JSON.parse(m);
                console.log('json');
                console.log(m);
                if (m.join !== undefined) {
                    onMessageJoin(m.join);
                }
                if (m.peers !== undefined) {
                    onMessagePeers(m.peers);
                }
                //TODO: other json data
            }
            catch(err) {
                console.log('string');
                // console.log(m);
                //TODO: non json data
            }
        }
        else {
            console.log('binary');
            //TODO: binary data
        }
    }

    function joinRoom(room, pass) {
        ws.send(JSON.stringify({join:{room:room,pass:pass}}));
    }

    function onMessageJoin(m) {
        console.log(m);
        if (m.success === false) {
            return;
        }
        navigator.getUserMedia = navigator.getUserMedia ||
                                navigator.webkitGetUserMedia ||
                                navigator.mozGetUserMedia;
        if (navigator.getUserMedia === undefined) {
            console.log('getUserMedia not supported by browser');
            alert('getUserMedia not supported by browser');
            onLocalStream(undefined, false, false);
            return;
        }
        navigator.getUserMedia({audio: true, video: true}, s => {
            onLocalStream(s, true, true);
        }, event => {
            console.log('Could not retrieve video input device');
            alert('Could not retrieve video input device');
            navigator.getUserMedia({audio: true}, s => {
                onLocalStream(s, false, true);
            }, event => {
                console.log('Could not retrieve audio input device');
                alert('Could not retrieve audio input device');
                onLocalStream(undefined, false, false);
            });
        });
    }

    function onLocalStream(s, video, audio) {
        // console.log('local stream');
        // console.log(s);
        if (s === undefined || (!audio && !video)) return undefined;
        if (video) {
            //TODO: set local media stream
            // elemVidLocal.src = window.URL.createObjectURL(localStream);
        }
        streamLocal = s;
        streamLocalReady = true;
        ws.send(JSON.stringify({peers:0}));
    }

    let peersProcessed = 0;
    let peers = [];
    function onMessagePeers(p) {
        if (!streamLocalReady || typeof p !== 'number' || p <= 0) return;
        for (let i = peersProcessed; i < p; i++, peersProcessed++) {
            peers.push(new RTCPeerConnection({
                iceServers: [
                    {url: 'stun:stun.1.google.com:19302'}
                ]
            }));
            //TODO: setup offer
        }
        console.log(peers);
    }

</script>
</body>
</html>
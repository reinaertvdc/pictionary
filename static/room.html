<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pictionary Game</title>
</head>
<body>
    <a href="/">HOME</a>
<script>

    let room = -1;
    let pass = '';

    let ws = undefined;

    if (typeof roomdetails !== 'undefined' && roomdetails !== undefined) {
        console.log(roomdetails);
        if (roomdetails.room !== undefined && typeof roomdetails.room === 'number') room = roomdetails.room;
        if (roomdetails.pass !== undefined && typeof roomdetails.pass === 'string') pass = roomdetails.pass;
    }
    else {
        room = parseInt(window.location.pathname.split('/',3)[2]);
    }
    if (room !== undefined && !isNaN(room)) {
        document.title = 'Pictionary Game (room ' + room + ')';
        createWebSocket().then(sock => {
            ws = sock;
            joinRoom(room, pass);
        }).catch(() => {
            //TODO: feedback to user
        });
    }

    function createWebSocket() {
        return new Promise((resolve, reject) => {
            let host = window.location.hostname;
            let port = 9004;
            let ws = new WebSocket('wss://' + host + ':' + port);
            ws.onopen = event => {
                resolve(ws);
            };
            ws.onerror = event => {
                ws = undefined;
                reject();
            };
            ws.onmessage = event => {
                onWebSocketMessage(event.data);
            }
        });
    }

    function onWebSocketMessage(m) {
        if (typeof m === 'string') {
            try {
                let m = JSON.parse(m);
                console.log(m);
                //TODO: json data
            }
            catch(err) {
                console.log('string');
                console.log(m);
                //TODO: non json data
            }
        }
        else {
            console.log('binary');
            //TODO: binary data
        }
    }

    function joinRoom(room, pass) {
        ws.send(JSON.stringify({join:{room:room,pass:pass}}));
    }

    function onMessageJoin

</script>
</body>
</html>